{
  "kind": "build_request",
  "title": "Fix actor initialization causing “Connection failed” service connection error",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-3",
      "text": "Fix frontend actor initialization so anonymous users do not fail to connect: ensure the React Query key used by `useActor` does not include `undefined` when there is no Internet Identity (so it matches `useActorInitStatus`), and ensure an anonymous actor can be created without errors.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "please fix this bug: Connection failed\n\nUnable to connect to the service. Please try again."
        ]
      },
      "acceptanceCriteria": [
        "When logged out (no Internet Identity), the actor initialization query uses a stable key (no `undefined` element) and does not enter an error state solely due to missing identity.",
        "The Today and Tomorrow pages no longer show the “Connection failed” screen for anonymous users if the backend is reachable."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Prevent actor initialization from failing due to missing admin token: only call `_initializeAccessControlWithSecret` when the `caffeineAdminToken` URL parameter is present and non-empty; do not call it with an empty string.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "please fix this bug: Connection failed\n\nUnable to connect to the service. Please try again."
        ]
      },
      "acceptanceCriteria": [
        "If `caffeineAdminToken` is absent, actor initialization completes without calling `_initializeAccessControlWithSecret`.",
        "If `caffeineAdminToken` is present and non-empty, `_initializeAccessControlWithSecret` is called once during actor creation and actor initialization succeeds when the token is valid.",
        "The “Retry Connection” button successfully retries actor initialization after adding/removing the admin token param."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Improve the connection failure UX for actor initialization errors: keep the existing English headline/body text, and additionally render a collapsible/secondary error detail area that shows a safe, developer-oriented message derived from the actor init error (e.g., error name/message) to help diagnose deployment/agent issues.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "Connection failed\n\nUnable to connect to the service. Please try again."
        ]
      },
      "acceptanceCriteria": [
        "On the actor initialization failure screen (Today and Tomorrow), the primary user-facing text remains in English and unchanged: “Connection failed” and “Unable to connect to the service. Please try again.”",
        "A secondary UI element shows error details (sanitized string) when an initialization error exists, without crashing if the error is not an `Error` instance.",
        "Retry still works and does not require a page reload."
      ]
    },
    {
      "id": "REQ-6",
      "text": "Ensure the backend access-control initialization method does not trap when called without a valid secret (defensive behavior): if `_initializeAccessControlWithSecret` is invoked with an empty or invalid secret, it must not trap; it should either no-op or return an error that the frontend can handle gracefully.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-3"
        ],
        "quotes": [
          "please fix this bug: Connection failed\n\nUnable to connect to the service. Please try again."
        ]
      },
      "acceptanceCriteria": [
        "Calling `_initializeAccessControlWithSecret(\"\")` does not trap the canister.",
        "If the secret is invalid, the canister remains usable for public methods (e.g., `determineNakshatra`) and does not block anonymous access due to a trap during initialization."
      ]
    }
  ],
  "constraints": [
    "Do not edit files under `frontend/src/components/ui` (compose them instead).",
    "Do not modify immutable paths: `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useInternetIdentity.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`.",
    "Backend must remain a single Motoko actor in `backend/main.mo`; only add `backend/migration.mo` if state schema changes (not expected for this fix)."
  ],
  "nonGoals": [
    "Adding new authentication providers beyond Internet Identity.",
    "Implementing real-time connectivity mechanisms (WebSockets, sockets, etc.).",
    "Changing nakshatra calculation logic or UI content unrelated to connection/initialization."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}