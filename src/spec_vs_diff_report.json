{
  "kind": "spec_vs_diff_report",
  "version": "1.0",
  "generatedAt": "2026-02-11T01:23:21.101Z",
  "summary": "Diff adds a new Nakshatra Calculator page/route and a reusable calculator section embedded in Profile, plus new backend types and a migration module. However, several key requirements are either not evidenced in the diff (backend API + persistence fix) or appear only partially implemented (saving full location details, clear validation errors, auth-blocked save messaging, and correct Atmakaraka computation method).",
  "missing_requirements": [
    {
      "id": "REQ-1",
      "requirement": "Fix backend persistence so saving and later fetching the caller’s user profile works reliably after login (data must survive across calls and not be lost due to non-mutating map updates).",
      "reason": "The diff shows `localUserProfiles = Map.empty<Principal, UserProfile>()` but does not show any `stable` state, proper map update patterns, or the implementations of `saveCallerUserProfile`/`getCallerUserProfile` demonstrating persistence and correct mutation. With truncation, the required fix is not verifiable from the provided evidence.",
      "evidence": [
        "backend/main.mo",
        "frontend/src/hooks/useUserProfile.ts"
      ]
    },
    {
      "id": "REQ-2",
      "requirement": "Store per-user birth data including DOB, TOB, and location (selected city details) along with computed Moon and Atmakaraka nakshatra names; handle existing saved birth chart data via migration if needed.",
      "reason": "While new backend types include a `BirthData` with `location : Location` (lat/long), the frontend save path passes only `location: currentCity.name` (a string) to `actor.saveBirthData(...)`, which does not evidence persisting selected city details (lat/long). Also, `backend/main.mo` still defines an older `BirthChartData` type (`birthDate`, `moonNakshatra`, `atmakarakaNakshatra`) and a `birthCharts` map, suggesting incomplete/unclear migration of existing birth-chart storage to the new schema.",
      "evidence": [
        "backend/main.mo",
        "backend/migration.mo",
        "frontend/src/hooks/useNakshatraCalculator.ts",
        "frontend/src/pages/NakshatraCalculatorPage.tsx",
        "frontend/src/components/nakshatra/NakshatraCalculatorSection.tsx"
      ]
    },
    {
      "id": "REQ-3",
      "requirement": "Backend callable API that accepts DOB, TOB, and location and returns both Moon and Atmakaraka nakshatra names with clear errors on invalid input.",
      "reason": "Frontend calls `actor.computeNakshatraData(moonLongitude, birthTime, birthLocation, dob, timeOfBirth)`, but the diff does not show the backend method definition/signature or any input validation/error behavior. Additionally, the API usage shown is not 'given DOB/TOB/location compute', since it requires a `moonLongitude` computed client-side.",
      "evidence": [
        "frontend/src/hooks/useNakshatraCalculator.ts",
        "frontend/src/pages/NakshatraCalculatorPage.tsx",
        "backend/main.mo (truncated; method not shown)"
      ]
    },
    {
      "id": "REQ-4",
      "requirement": "Header navigation includes a link to a new navigation tab labeled “Nakshatra Calculator”.",
      "reason": "Navigation link added is labeled “Calculator”, not “Nakshatra Calculator” as specified.",
      "evidence": [
        "frontend/src/components/layout/AppHeader.tsx"
      ]
    },
    {
      "id": "REQ-5",
      "requirement": "When not logged in, calculator can compute but saving is blocked with an English sign-in prompt.",
      "reason": "On the calculator page, `handleSave` returns early when not authenticated (`if (!calculatedResults || !isAuthenticated) return;`) but there is no evidence of a UI prompt/message telling the user to sign in when save is blocked.",
      "evidence": [
        "frontend/src/pages/NakshatraCalculatorPage.tsx"
      ]
    },
    {
      "id": "REQ-5",
      "requirement": "Saving persists DOB/TOB/location (city details) and computed nakshatras to backend and Profile displays stored DOB/TOB/location and both nakshatras.",
      "reason": "The save hook sends only a string `location` (city name), not city details. Also, the truncated Profile page content shows embedding `NakshatraCalculatorSection` but does not provide evidence that Profile renders stored DOB/TOB/location + nakshatra values outside the embedded calculator or that the embedded section is wired to show a 'Save to Profile' action with appropriate states.",
      "evidence": [
        "frontend/src/hooks/useNakshatraCalculator.ts",
        "frontend/src/pages/ProfileSettingsPage.tsx",
        "frontend/src/components/nakshatra/NakshatraCalculatorSection.tsx"
      ]
    }
  ],
  "hallucinated_features": [
    {
      "description": "Nakshatra computation API appears to require client-provided `moonLongitude` (computed in the browser) rather than computing from DOB/TOB/location on the backend.",
      "reason": "REQ-3 specifies backend computation given DOB/TOB/location. The diff shows frontend computing `moonLongitude = calculateMoonLongitude(birthDateTime)` and passing it into `computeNakshatraData`, implying a different architecture than requested.",
      "evidence": [
        "frontend/src/pages/NakshatraCalculatorPage.tsx",
        "frontend/src/components/nakshatra/NakshatraCalculatorSection.tsx",
        "frontend/src/hooks/useNakshatraCalculator.ts"
      ]
    }
  ],
  "confidence": 0.68,
  "changed_files": [
    "backend/main.mo",
    "backend/migration.mo",
    "frontend-file-summaries.txt",
    "frontend/src/App.tsx",
    "frontend/src/components/layout/AppHeader.tsx",
    "frontend/src/components/nakshatra/NakshatraCalculatorSection.tsx",
    "frontend/src/hooks/useNakshatraCalculator.ts",
    "frontend/src/hooks/useUserProfile.ts",
    "frontend/src/pages/NakshatraCalculatorPage.tsx",
    "frontend/src/pages/ProfileSettingsPage.tsx",
    "project_state.json"
  ]
}